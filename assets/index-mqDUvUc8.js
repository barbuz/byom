var Tt=Object.defineProperty;var Rt=(n,e,t)=>e in n?Tt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var je=(n,e,t)=>Rt(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const r of s.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();function J(){}function ut(n){return n()}function xe(){return Object.create(null)}function Q(n){n.forEach(ut)}function ft(n){return typeof n=="function"}function Ye(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}let Ce;function $e(n,e){return n===e?!0:(Ce||(Ce=document.createElement("a")),Ce.href=e,n===Ce.href)}function At(n){return Object.keys(n).length===0}function f(n,e){n.appendChild(e)}function j(n,e,t){n.insertBefore(e,t||null)}function O(n){n.parentNode&&n.parentNode.removeChild(n)}function h(n){return document.createElement(n)}function T(n){return document.createTextNode(n)}function C(){return T(" ")}function Ft(){return T("")}function Y(n,e,t,o){return n.addEventListener(e,t,o),()=>n.removeEventListener(e,t,o)}function zt(n){return function(e){return e.stopPropagation(),n.call(this,e)}}function p(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function ue(n){return n===""?null:+n}function Dt(n){return Array.from(n.childNodes)}function Z(n,e){e=""+e,n.data!==e&&(n.data=e)}function ce(n,e){n.value=e??""}function Ot(n,e,t,o){n.style.setProperty(e,t,"")}function Wt(n,e,{bubbles:t=!1,cancelable:o=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:o})}let ke;function ye(n){ke=n}function Ze(){if(!ke)throw new Error("Function called outside component initialization");return ke}function Xe(n){Ze().$$.on_mount.push(n)}function qt(n){Ze().$$.on_destroy.push(n)}function Bt(){const n=Ze();return(e,t,{cancelable:o=!1}={})=>{const i=n.$$.callbacks[e];if(i){const s=Wt(e,t,{cancelable:o});return i.slice().forEach(r=>{r.call(n,s)}),!s.defaultPrevented}return!0}}function jt(n,e){const t=n.$$.callbacks[e.type];t&&t.slice().forEach(o=>o.call(this,e))}const be=[],we=[];let ve=[];const et=[],dt=Promise.resolve();let Ue=!1;function mt(){Ue||(Ue=!0,dt.then(pt))}function He(){return mt(),dt}function Ge(n){ve.push(n)}const Ne=new Set;let _e=0;function pt(){if(_e!==0)return;const n=ke;do{try{for(;_e<be.length;){const e=be[_e];_e++,ye(e),Ht(e.$$)}}catch(e){throw be.length=0,_e=0,e}for(ye(null),be.length=0,_e=0;we.length;)we.pop()();for(let e=0;e<ve.length;e+=1){const t=ve[e];Ne.has(t)||(Ne.add(t),t())}ve.length=0}while(be.length);for(;et.length;)et.pop()();Ue=!1,Ne.clear(),ye(n)}function Ht(n){if(n.fragment!==null){n.update(),Q(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(Ge)}}function Nt(n){const e=[],t=[];ve.forEach(o=>n.indexOf(o)===-1?e.push(o):t.push(o)),t.forEach(o=>o()),ve=e}const Ie=new Set;let pe;function gt(){pe={r:0,c:[],p:pe}}function ht(){pe.r||Q(pe.c),pe=pe.p}function ne(n,e){n&&n.i&&(Ie.delete(n),n.i(e))}function ge(n,e,t,o){if(n&&n.o){if(Ie.has(n))return;Ie.add(n),pe.c.push(()=>{Ie.delete(n),o&&(t&&n.d(1),o())}),n.o(e)}else o&&o()}function tt(n){return(n==null?void 0:n.length)!==void 0?n:Array.from(n)}function Ut(n,e){n.d(1),e.delete(n.key)}function Gt(n,e,t,o,i,s,r,a,c,l,m,u){let d=n.length,g=s.length,_=d;const v={};for(;_--;)v[n[_].key]=_;const k=[],S=new Map,R=new Map,W=[];for(_=g;_--;){const w=u(i,s,_),y=t(w);let A=r.get(y);A?W.push(()=>A.p(w,e)):(A=l(y,w),A.c()),S.set(y,k[_]=A),y in v&&R.set(y,Math.abs(_-v[y]))}const P=new Set,z=new Set;function H(w){ne(w,1),w.m(a,m),r.set(w.key,w),m=w.first,g--}for(;d&&g;){const w=k[g-1],y=n[d-1],A=w.key,D=y.key;w===y?(m=w.first,d--,g--):S.has(D)?!r.has(A)||P.has(A)?H(w):z.has(D)?d--:R.get(A)>R.get(D)?(z.add(A),H(w)):(P.add(D),d--):(c(y,r),d--)}for(;d--;){const w=n[d];S.has(w.key)||c(w,r)}for(;g;)H(k[g-1]);return Q(W),k}function Je(n){n&&n.c()}function Le(n,e,t){const{fragment:o,after_update:i}=n.$$;o&&o.m(e,t),Ge(()=>{const s=n.$$.on_mount.map(ut).filter(ft);n.$$.on_destroy?n.$$.on_destroy.push(...s):Q(s),n.$$.on_mount=[]}),i.forEach(Ge)}function Te(n,e){const t=n.$$;t.fragment!==null&&(Nt(t.after_update),Q(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Vt(n,e){n.$$.dirty[0]===-1&&(be.push(n),mt(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function Re(n,e,t,o,i,s,r=null,a=[-1]){const c=ke;ye(n);const l=n.$$={fragment:null,ctx:[],props:s,update:J,not_equal:i,bound:xe(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(c?c.$$.context:[])),callbacks:xe(),dirty:a,skip_bound:!1,root:e.target||c.$$.root};r&&r(l.root);let m=!1;if(l.ctx=t?t(n,e.props||{},(u,d,...g)=>{const _=g.length?g[0]:d;return l.ctx&&i(l.ctx[u],l.ctx[u]=_)&&(!l.skip_bound&&l.bound[u]&&l.bound[u](_),m&&Vt(n,u)),d}):[],l.update(),m=!0,Q(l.before_update),l.fragment=o?o(l.ctx):!1,e.target){if(e.hydrate){const u=Dt(e.target);l.fragment&&l.fragment.l(u),u.forEach(O)}else l.fragment&&l.fragment.c();e.intro&&ne(n.$$.fragment),Le(n,e.target,e.anchor),pt()}ye(c)}class Ae{constructor(){je(this,"$$");je(this,"$$set")}$destroy(){Te(this,1),this.$destroy=J}$on(e,t){if(!ft(t))return J;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(t),()=>{const i=o.indexOf(t);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!At(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Kt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Kt);const Zt="byom-db",Jt=1,oe="maps",x="referencePoints";let Ee=null;async function le(){return Ee||new Promise((n,e)=>{const t=indexedDB.open(Zt,Jt);t.onerror=()=>e(t.error),t.onsuccess=()=>{Ee=t.result,n(Ee)},t.onupgradeneeded=o=>{const i=o.target.result;if(!i.objectStoreNames.contains(oe)){const s=i.createObjectStore(oe,{keyPath:"id",autoIncrement:!0});s.createIndex("timestamp","timestamp",{unique:!1}),s.createIndex("name","name",{unique:!1})}i.objectStoreNames.contains(x)||i.createObjectStore(x,{keyPath:"id",autoIncrement:!0}).createIndex("mapId","mapId",{unique:!1})}})}async function _t(n){const e=await le();return new Promise((t,o)=>{const s=e.transaction([oe],"readwrite").objectStore(oe),r={name:n.name,imageBlob:n.imageBlob,thumbnail:n.thumbnail,timestamp:Date.now()},a=s.add(r);a.onsuccess=()=>t(a.result),a.onerror=()=>o(a.error)})}async function bt(){const n=await le();return new Promise((e,t)=>{const s=n.transaction([oe],"readonly").objectStore(oe).getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}async function vt(n){const e=await le();return new Promise((t,o)=>{const r=e.transaction([oe],"readonly").objectStore(oe).get(n);r.onsuccess=()=>t(r.result),r.onerror=()=>o(r.error)})}async function yt(n){const e=await le();return new Promise((t,o)=>{const i=e.transaction([oe,x],"readwrite");i.objectStore(oe).delete(n);const a=i.objectStore(x).index("mapId"),c=IDBKeyRange.only(n),l=a.openCursor(c);l.onsuccess=m=>{const u=m.target.result;u&&(u.delete(),u.continue())},i.oncomplete=()=>t(),i.onerror=()=>o(i.error)})}async function kt(n){const e=await le();return new Promise((t,o)=>{const s=e.transaction([x],"readwrite").objectStore(x),r={mapId:n.mapId,imageX:n.imageX,imageY:n.imageY,lon:n.lon,lat:n.lat,timestamp:Date.now()},a=s.add(r);a.onsuccess=()=>t(a.result),a.onerror=()=>o(a.error)})}async function wt(n){const e=await le();return new Promise((t,o)=>{const a=e.transaction([x],"readonly").objectStore(x).index("mapId").getAll(n);a.onsuccess=()=>t(a.result),a.onerror=()=>o(a.error)})}async function Qt(n,e){const t=await le();return new Promise((o,i)=>{const r=t.transaction([x],"readwrite").objectStore(x),a=r.get(n);a.onsuccess=()=>{const c=a.result;if(!c){i(new Error("Point not found"));return}const l={...c,...e},m=r.put(l);m.onsuccess=()=>o(l),m.onerror=()=>i(m.error)},a.onerror=()=>i(a.error)})}async function xt(n){const e=await le();return new Promise((t,o)=>{const r=e.transaction([x],"readwrite").objectStore(x).delete(n);r.onsuccess=()=>t(),r.onerror=()=>o(r.error)})}const nt=Object.freeze(Object.defineProperty({__proto__:null,addMap:_t,addReferencePoint:kt,deleteMap:yt,deleteReferencePoint:xt,getAllMaps:bt,getMap:vt,getReferencePoints:wt,initDB:le,updateReferencePoint:Qt},Symbol.toStringTag,{value:"Module"}));function ot(n,e,t){const o=n.slice();return o[8]=e[t],o}function $t(n){let e,t=[],o=new Map,i=tt(n[0]);const s=r=>r[8].id;for(let r=0;r<i.length;r+=1){let a=ot(n,i,r),c=s(a);o.set(c,t[r]=lt(c,a))}return{c(){e=h("div");for(let r=0;r<t.length;r+=1)t[r].c();p(e,"class","maps-grid svelte-1pkgs5k")},m(r,a){j(r,e,a);for(let c=0;c<t.length;c+=1)t[c]&&t[c].m(e,null)},p(r,a){a&9&&(i=tt(r[0]),t=Gt(t,a,s,1,r,i,o,e,Ut,lt,null,ot))},d(r){r&&O(e);for(let a=0;a<t.length;a+=1)t[a].d()}}}function en(n){let e;return{c(){e=h("div"),e.innerHTML='<p class="svelte-1pkgs5k">No maps yet</p> <p class="hint svelte-1pkgs5k">Tap &quot;Add Map&quot; to get started</p>',p(e,"class","empty-state svelte-1pkgs5k")},m(t,o){j(t,e,o)},p:J,d(t){t&&O(e)}}}function tn(n){let e;return{c(){e=h("div"),e.textContent="Loading maps...",p(e,"class","loading svelte-1pkgs5k")},m(t,o){j(t,e,o)},p:J,d(t){t&&O(e)}}}function lt(n,e){let t,o,i,s,r,a,c,l,m=e[8].name+"",u,d,g,_=new Date(e[8].timestamp).toLocaleDateString()+"",v,k,S,R,W,P;function z(...w){return e[4](e[8],...w)}function H(){return e[5](e[8])}return{key:n,first:null,c(){t=h("div"),o=h("div"),i=h("img"),a=C(),c=h("div"),l=h("div"),u=T(m),d=C(),g=h("div"),v=T(_),k=C(),S=h("button"),S.textContent="√ó",R=C(),$e(i.src,s=e[8].thumbnail)||p(i,"src",s),p(i,"alt",r=e[8].name),p(i,"class","svelte-1pkgs5k"),p(o,"class","map-thumbnail svelte-1pkgs5k"),p(l,"class","map-name svelte-1pkgs5k"),p(g,"class","map-date svelte-1pkgs5k"),p(c,"class","map-info svelte-1pkgs5k"),p(S,"class","delete-btn svelte-1pkgs5k"),p(S,"aria-label","Delete map"),p(t,"class","map-card svelte-1pkgs5k"),this.first=t},m(w,y){j(w,t,y),f(t,o),f(o,i),f(t,a),f(t,c),f(c,l),f(l,u),f(c,d),f(c,g),f(g,v),f(t,k),f(t,S),f(t,R),W||(P=[Y(S,"click",z),Y(t,"click",H)],W=!0)},p(w,y){e=w,y&1&&!$e(i.src,s=e[8].thumbnail)&&p(i,"src",s),y&1&&r!==(r=e[8].name)&&p(i,"alt",r),y&1&&m!==(m=e[8].name+"")&&Z(u,m),y&1&&_!==(_=new Date(e[8].timestamp).toLocaleDateString()+"")&&Z(v,_)},d(w){w&&O(t),W=!1,Q(P)}}}function nn(n){let e,t,o,i,s,r,a,c,l,m;function u(_,v){return _[1]?tn:_[0].length===0?en:$t}let d=u(n),g=d(n);return{c(){e=h("div"),t=h("header"),t.innerHTML='<h1 class="svelte-1pkgs5k">üó∫Ô∏è BYOM</h1> <p class="svelte-1pkgs5k">Bring Your Own Map</p>',o=C(),i=h("div"),s=h("label"),s.textContent="üì∑ Add Map",r=C(),a=h("input"),c=C(),g.c(),p(t,"class","svelte-1pkgs5k"),p(s,"for","file-upload"),p(s,"class","upload-btn svelte-1pkgs5k"),p(a,"id","file-upload"),p(a,"type","file"),p(a,"accept","image/*"),p(a,"capture","environment"),a.multiple=!0,Ot(a,"display","none"),p(i,"class","upload-section svelte-1pkgs5k"),p(e,"class","container svelte-1pkgs5k")},m(_,v){j(_,e,v),f(e,t),f(e,o),f(e,i),f(i,s),f(i,r),f(i,a),f(e,c),g.m(e,null),l||(m=Y(a,"change",n[2]),l=!0)},p(_,[v]){d===(d=u(_))&&g?g.p(_,v):(g.d(1),g=d(_),g&&(g.c(),g.m(e,null)))},i:J,o:J,d(_){_&&O(e),g.d(),l=!1,m()}}}async function on(n){return new Promise((e,t)=>{const o=new FileReader;o.onload=i=>{const s=new Image;s.onload=()=>{const r=document.createElement("canvas"),a=200;let c=s.width,l=s.height;c>l?c>a&&(l*=a/c,c=a):l>a&&(c*=a/l,l=a),r.width=c,r.height=l,r.getContext("2d").drawImage(s,0,0,c,l),e(r.toDataURL("image/jpeg",.7))},s.onerror=t,s.src=i.target.result},o.onerror=t,o.readAsDataURL(n)})}function ln(n){window.location.hash=`#map/${n}`}function sn(n,e,t){let o=[],i=!0;Xe(async()=>{await s()});async function s(){t(1,i=!0);try{t(0,o=await bt()),o.sort((u,d)=>d.timestamp-u.timestamp)}catch(u){console.error("Error loading maps:",u),alert("Failed to load maps")}finally{t(1,i=!1)}}async function r(u){const d=u.target.files;if(!(!d||d.length===0)){for(const g of d)await a(g);await s(),u.target.value=""}}async function a(u){try{const d=await on(u),g={name:u.name,imageBlob:u,thumbnail:d};await _t(g)}catch(d){console.error("Error processing image:",d),alert(`Failed to process ${u.name}`)}}async function c(u,d){if(d.stopPropagation(),!!confirm("Delete this map and all its reference points?"))try{await yt(u),await s()}catch(g){console.error("Error deleting map:",g),alert("Failed to delete map")}}return[o,i,r,c,(u,d)=>c(u.id,d),u=>ln(u.id)]}class rn extends Ae{constructor(e){super(),Re(this,e,sn,nn,Ye,{})}}const an="modulepreload",cn=function(n){return"/byom/"+n},it={},Ve=function(e,t,o){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));i=Promise.allSettled(t.map(c=>{if(c=cn(c),c in it)return;it[c]=!0;const l=c.endsWith(".css"),m=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${m}`))return;const u=document.createElement("link");if(u.rel=l?"stylesheet":an,l||(u.as="script"),u.crossOrigin="",u.href=c,a&&u.setAttribute("nonce",a),document.head.appendChild(u),l)return new Promise((d,g)=>{u.addEventListener("load",d),u.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return i.then(r=>{for(const a of r||[])a.status==="rejected"&&s(a.reason);return e().catch(s)})};function un(n){if(n.length<2)throw new Error("Need at least 2 reference points");const e=n[0],t=n[1],o=t.imageX-e.imageX,i=t.imageY-e.imageY,s=t.lon-e.lon,r=t.lat-e.lat,a=Math.sqrt(o*o+i*i),l=Math.sqrt(s*s+r*r)/a,m=Math.atan2(i,o),d=Math.atan2(r,s)-m,g=Math.cos(d),_=Math.sin(d),v=e.lon-(l*g*e.imageX-l*_*e.imageY),k=e.lat-(l*_*e.imageX+l*g*e.imageY);return{scale:l,rotation:d,tx:v,ty:k}}function fn(n){if(n.length<3)throw new Error("Need at least 3 reference points for affine transform");const e=n.length;let t=0,o=0,i=0,s=0,r=0,a=0,c=0,l=0,m=0,u=0,d=0;for(const P of n)t+=P.imageX,o+=P.imageY,i+=P.imageX*P.imageX,s+=P.imageY*P.imageY,r+=P.imageX*P.imageY,a+=P.lon,c+=P.lat,l+=P.imageX*P.lon,m+=P.imageY*P.lon,u+=P.imageX*P.lat,d+=P.imageY*P.lat;const g=e*(i*s-r*r)-t*(t*s-o*r)+o*(t*r-o*i);if(Math.abs(g)<1e-10)throw new Error("Points are collinear, cannot compute affine transform");const _=(e*(l*s-m*r)-t*(a*s-o*m)+o*(a*r-o*l))/g,v=(e*(i*m-r*l)-t*(t*m-o*l)+o*(t*a-i*a))/g,k=(a-_*t-v*o)/e,S=(e*(u*s-d*r)-t*(c*s-o*d)+o*(c*r-o*u))/g,R=(e*(i*d-r*u)-t*(t*d-o*u)+o*(t*c-i*c))/g,W=(c-S*t-R*o)/e;return{a:_,b:v,c:k,d:S,e:R,f:W}}function dn(n,e,t,o){if(o==="similarity"){const{scale:i,rotation:s,tx:r,ty:a}=t,c=Math.cos(s),l=Math.sin(s),m=n-r,u=e-a,d=(c*m+l*u)/i,g=(-l*m+c*u)/i;return{imageX:d,imageY:g}}else if(o==="affine"){const{a:i,b:s,c:r,d:a,e:c,f:l}=t,m=i*c-s*a;if(Math.abs(m)<1e-10)throw new Error("Transform is singular");const u=n-r,d=e-l,g=(c*u-s*d)/m,_=(-a*u+i*d)/m;return{imageX:g,imageY:_}}throw new Error("Unknown transform type")}function mn(n){return!n||n.length<2?null:n.length===2?{transform:un(n),type:"similarity"}:{transform:fn(n),type:"affine"}}function pn(n){let e,t,o,i,s,r,a,c,l,m,u,d;function g(k,S){if(!k[5])return vn;if(k[5]==="gps")return bn;if(k[5]==="manual")return _n;if(k[5]==="map")return hn}let _=g(n),v=_&&_(n);return{c(){e=h("div"),t=h("p"),t.textContent="Select the real-world coordinates",o=C(),v&&v.c(),i=C(),s=h("div"),r=h("button"),r.textContent="‚Üê Back",a=C(),c=h("button"),l=T("Save Point"),p(t,"class","instruction svelte-oiefmn"),p(r,"class","btn btn-secondary svelte-oiefmn"),p(c,"class","btn btn-primary svelte-oiefmn"),c.disabled=m=!n[11],p(s,"class","step-actions svelte-oiefmn"),p(e,"class","step-content svelte-oiefmn")},m(k,S){j(k,e,S),f(e,t),f(e,o),v&&v.m(e,null),f(e,i),f(e,s),f(s,r),f(s,a),f(s,c),f(c,l),u||(d=[Y(r,"click",n[14]),Y(c,"click",n[18])],u=!0)},p(k,S){_===(_=g(k))&&v?v.p(k,S):(v&&v.d(1),v=_&&_(k),v&&(v.c(),v.m(e,i))),S[0]&2048&&m!==(m=!k[11])&&(c.disabled=m)},d(k){k&&O(e),v&&v.d(),u=!1,Q(d)}}}function gn(n){let e,t,o,i,s,r,a,c,l,m,u,d,g,_;return{c(){e=h("div"),t=h("p"),t.textContent="Tap on the image to select a point",o=C(),i=h("div"),s=h("canvas"),r=C(),a=h("div"),c=h("button"),c.textContent="Cancel",l=C(),m=h("button"),u=T("Next ‚Üí"),p(t,"class","instruction svelte-oiefmn"),p(s,"class","svelte-oiefmn"),p(i,"class","image-container svelte-oiefmn"),p(c,"class","btn btn-secondary svelte-oiefmn"),p(m,"class","btn btn-primary svelte-oiefmn"),m.disabled=d=!n[1],p(a,"class","step-actions svelte-oiefmn"),p(e,"class","step-content svelte-oiefmn")},m(v,k){j(v,e,k),f(e,t),f(e,o),f(e,i),f(i,s),n[25](s),f(e,r),f(e,a),f(a,c),f(a,l),f(a,m),f(m,u),g||(_=[Y(s,"click",n[12]),Y(c,"click",n[19]),Y(m,"click",n[13])],g=!0)},p(v,k){k[0]&2&&d!==(d=!v[1])&&(m.disabled=d)},d(v){v&&O(e),n[25](null),g=!1,Q(_)}}}function hn(n){let e,t,o,i,s,r,a,c,l,m=n[3]!==null&&n[4]!==null&&st(n);return{c(){e=h("div"),t=h("p"),t.textContent="Click on the map to select coordinates",o=C(),i=h("div"),s=C(),m&&m.c(),r=C(),a=h("button"),a.textContent="Choose Different Method",p(t,"class","map-instruction svelte-oiefmn"),p(i,"class","map-container svelte-oiefmn"),p(a,"class","btn btn-secondary svelte-oiefmn"),p(e,"class","map-input svelte-oiefmn")},m(u,d){j(u,e,d),f(e,t),f(e,o),f(e,i),n[33](i),f(e,s),m&&m.m(e,null),f(e,r),f(e,a),c||(l=Y(a,"click",n[34]),c=!0)},p(u,d){u[3]!==null&&u[4]!==null?m?m.p(u,d):(m=st(u),m.c(),m.m(e,r)):m&&(m.d(1),m=null)},d(u){u&&O(e),n[33](null),m&&m.d(),c=!1,l()}}}function _n(n){let e,t,o,i,s,r,a,c,l,m,u,d,g,_,v,k;return{c(){e=h("div"),t=h("div"),o=h("label"),o.textContent="Latitude (-90 to 90)",i=C(),s=h("input"),r=C(),a=h("div"),c=h("label"),c.textContent="Longitude (-180 to 180)",l=C(),m=h("input"),u=C(),d=h("button"),d.textContent="Use These Coordinates",g=C(),_=h("button"),_.textContent="Choose Different Method",p(o,"for","lat-input"),p(o,"class","svelte-oiefmn"),p(s,"id","lat-input"),p(s,"type","number"),p(s,"step","any"),p(s,"placeholder","e.g., 40.7128"),p(s,"class","svelte-oiefmn"),p(t,"class","input-group svelte-oiefmn"),p(c,"for","lon-input"),p(c,"class","svelte-oiefmn"),p(m,"id","lon-input"),p(m,"type","number"),p(m,"step","any"),p(m,"placeholder","e.g., -74.0060"),p(m,"class","svelte-oiefmn"),p(a,"class","input-group svelte-oiefmn"),p(d,"class","btn btn-primary svelte-oiefmn"),p(_,"class","btn btn-secondary svelte-oiefmn"),p(e,"class","coordinate-input svelte-oiefmn")},m(S,R){j(S,e,R),f(e,t),f(t,o),f(t,i),f(t,s),ce(s,n[6]),f(e,r),f(e,a),f(a,c),f(a,l),f(a,m),ce(m,n[7]),f(e,u),f(e,d),f(e,g),f(e,_),v||(k=[Y(s,"input",n[30]),Y(m,"input",n[31]),Y(d,"click",n[17]),Y(_,"click",n[32])],v=!0)},p(S,R){R[0]&64&&ue(s.value)!==S[6]&&ce(s,S[6]),R[0]&128&&ue(m.value)!==S[7]&&ce(m,S[7])},d(S){S&&O(e),v=!1,Q(k)}}}function bn(n){let e,t,o,i,s;function r(l,m){return l[9]?wn:l[8]?kn:yn}let a=r(n),c=a(n);return{c(){e=h("div"),c.c(),t=C(),o=h("button"),o.textContent="Choose Different Method",p(o,"class","btn btn-secondary svelte-oiefmn"),p(e,"class","coordinate-input svelte-oiefmn")},m(l,m){j(l,e,m),c.m(e,null),f(e,t),f(e,o),i||(s=Y(o,"click",n[29]),i=!0)},p(l,m){a===(a=r(l))&&c?c.p(l,m):(c.d(1),c=a(l),c&&(c.c(),c.m(e,t)))},d(l){l&&O(e),c.d(),i=!1,s()}}}function vn(n){let e,t,o,i,s,r,a,c;return{c(){e=h("div"),t=h("button"),t.innerHTML='<div class="method-icon svelte-oiefmn">üìç</div> <div class="method-title svelte-oiefmn">Use GPS</div> <div class="method-desc svelte-oiefmn">Use current device location</div>',o=C(),i=h("button"),i.innerHTML='<div class="method-icon svelte-oiefmn">‚å®Ô∏è</div> <div class="method-title svelte-oiefmn">Manual Entry</div> <div class="method-desc svelte-oiefmn">Type coordinates</div>',s=C(),r=h("button"),r.innerHTML='<div class="method-icon svelte-oiefmn">üó∫Ô∏è</div> <div class="method-title svelte-oiefmn">Select on Map</div> <div class="method-desc svelte-oiefmn">Choose from OSM map (online)</div>',p(t,"class","method-btn svelte-oiefmn"),p(i,"class","method-btn svelte-oiefmn"),p(r,"class","method-btn svelte-oiefmn"),p(e,"class","method-selection svelte-oiefmn")},m(l,m){j(l,e,m),f(e,t),f(e,o),f(e,i),f(e,s),f(e,r),a||(c=[Y(t,"click",n[26]),Y(i,"click",n[27]),Y(r,"click",n[28])],a=!0)},p:J,d(l){l&&O(e),a=!1,Q(c)}}}function st(n){let e,t,o=n[4].toFixed(6)+"",i,s,r=n[3].toFixed(6)+"",a;return{c(){e=h("div"),t=T("Selected: "),i=T(o),s=T(", "),a=T(r),p(e,"class","coords-display svelte-oiefmn")},m(c,l){j(c,e,l),f(e,t),f(e,i),f(e,s),f(e,a)},p(c,l){l[0]&16&&o!==(o=c[4].toFixed(6)+"")&&Z(i,o),l[0]&8&&r!==(r=c[3].toFixed(6)+"")&&Z(a,r)},d(c){c&&O(e)}}}function yn(n){let e;return{c(){e=h("div"),e.textContent="üì° Getting GPS location...",p(e,"class","loading-message svelte-oiefmn")},m(t,o){j(t,e,o)},p:J,d(t){t&&O(e)}}}function kn(n){let e,t,o,i,s=n[8].lat.toFixed(6)+"",r,a,c,l=n[8].lon.toFixed(6)+"",m;return{c(){e=h("div"),t=T(`‚úì GPS location acquired\r
                `),o=h("div"),i=T("Lat: "),r=T(s),a=h("br"),c=T(`\r
                  Lon: `),m=T(l),p(o,"class","coords-display svelte-oiefmn"),p(e,"class","success-message svelte-oiefmn")},m(u,d){j(u,e,d),f(e,t),f(e,o),f(o,i),f(o,r),f(o,a),f(o,c),f(o,m)},p(u,d){d[0]&256&&s!==(s=u[8].lat.toFixed(6)+"")&&Z(r,s),d[0]&256&&l!==(l=u[8].lon.toFixed(6)+"")&&Z(m,l)},d(u){u&&O(e)}}}function wn(n){let e,t,o,i,s,r;return{c(){e=h("div"),t=T(n[9]),o=C(),i=h("button"),i.textContent="Try Again",p(e,"class","error-message svelte-oiefmn"),p(i,"class","btn btn-secondary svelte-oiefmn")},m(a,c){j(a,e,c),f(e,t),j(a,o,c),j(a,i,c),s||(r=Y(i,"click",n[16]),s=!0)},p(a,c){c[0]&512&&Z(t,a[9])},d(a){a&&(O(e),O(o),O(i)),s=!1,r()}}}function Pn(n){let e,t,o,i,s,r,a,c,l;function m(g,_){if(g[0]==="image")return gn;if(g[0]==="coordinates")return pn}let u=m(n),d=u&&u(n);return{c(){e=h("div"),t=h("div"),o=h("div"),i=h("h2"),i.textContent="Add Reference Point",s=C(),r=h("button"),r.textContent="√ó",a=C(),d&&d.c(),p(i,"class","svelte-oiefmn"),p(r,"class","close-btn svelte-oiefmn"),p(o,"class","picker-header svelte-oiefmn"),p(t,"class","picker-container svelte-oiefmn"),p(e,"class","picker-overlay svelte-oiefmn")},m(g,_){j(g,e,_),f(e,t),f(t,o),f(o,i),f(o,s),f(o,r),f(t,a),d&&d.m(t,null),c||(l=Y(r,"click",n[19]),c=!0)},p(g,_){u===(u=m(g))&&d?d.p(g,_):(d&&d.d(1),d=u&&u(g),d&&(d.c(),d.m(t,null)))},i:J,o:J,d(g){g&&O(e),d&&d.d(),c=!1,l()}}}function Sn(n,e,t){let o,{mapId:i}=e,{imageUrl:s}=e,{imageWidth:r}=e,{imageHeight:a}=e;const c=Bt();let l="image",m=null,u=null,d,g,_,v=1,k="",S="",R=null,W=null,P,z,H=null,w=null,y=null,A=!1;function D(){!d||!s||A||(t(24,A=!0),g=d.getContext("2d"),_=new Image,_.onload=()=>{const E=d.parentElement.clientWidth,U=d.parentElement.clientHeight,ee=E/r,te=U/a;v=Math.min(ee,te,1);const Pe=r*v,Se=a*v;t(2,d.width=Pe,d),t(2,d.height=Se,d),g.drawImage(_,0,0,Pe,Se)},_.src=s)}function M(E){const U=d.getBoundingClientRect(),ee=(E.clientX-U.left)/v,te=(E.clientY-U.top)/v;t(1,m={x:ee,y:te}),g.clearRect(0,0,d.width,d.height),g.drawImage(_,0,0,d.width,d.height),g.fillStyle="rgba(33, 150, 243, 0.7)",g.beginPath(),g.arc(ee*v,te*v,12,0,Math.PI*2),g.fill(),g.strokeStyle="white",g.lineWidth=3,g.stroke()}function q(){l==="image"&&m&&t(0,l="coordinates")}function L(){l==="coordinates"&&(t(0,l="image"),t(5,u=null),t(3,w=null),t(4,y=null),t(24,A=!1),He().then(()=>D()))}function X(E){t(5,u=E),E==="gps"?F():E==="map"&&setTimeout(()=>re(),100)}function F(){if(t(9,W=null),!navigator.geolocation){t(9,W="Geolocation not supported");return}navigator.geolocation.getCurrentPosition(E=>{t(8,R={lat:E.coords.latitude,lon:E.coords.longitude}),t(4,y=R.lat),t(3,w=R.lon)},E=>{t(9,W=`GPS error: ${E.message}`)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}function ie(){const E=parseFloat(k),U=parseFloat(S);if(isNaN(E)||isNaN(U)){alert("Please enter valid numbers");return}if(E<-90||E>90){alert("Latitude must be between -90 and 90");return}if(U<-180||U>180){alert("Longitude must be between -180 and 180");return}t(4,y=E),t(3,w=U)}async function re(){if(!P)return;const E=await Ve(()=>import("./maplibre-gl-mgRGZcVX.js").then(U=>U.m),[]);z=new E.Map({container:P,style:{version:8,sources:{osm:{type:"raster",tiles:["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","https://b.tile.openstreetmap.org/{z}/{x}/{y}.png","https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"¬© OpenStreetMap contributors"}},layers:[{id:"osm",type:"raster",source:"osm"}]},center:[0,0],zoom:2}),z.on("click",U=>{const{lng:ee,lat:te}=U.lngLat;t(3,w=ee),t(4,y=te),H?H.setLngLat([ee,te]):H=new E.Marker({color:"#2196F3"}).setLngLat([ee,te]).addTo(z)}),navigator.geolocation&&navigator.geolocation.getCurrentPosition(U=>{z.setCenter([U.coords.longitude,U.coords.latitude]),z.setZoom(10)},()=>{})}async function se(){if(o)try{await kt({mapId:parseInt(i),imageX:m.x,imageY:m.y,lon:w,lat:y}),c("added")}catch(E){console.error("Error saving reference point:",E),alert("Failed to save reference point")}}function fe(){t(24,A=!1),c("close")}Xe(async()=>{l==="image"&&(await He(),D())});function N(E){we[E?"unshift":"push"](()=>{d=E,t(2,d)})}const de=()=>X("gps"),he=()=>X("manual"),V=()=>X("map"),$=()=>t(5,u=null);function Fe(){k=ue(this.value),t(6,k)}function ze(){S=ue(this.value),t(7,S)}const De=()=>t(5,u=null);function Oe(E){we[E?"unshift":"push"](()=>{P=E,t(10,P)})}const We=()=>t(5,u=null);return n.$$set=E=>{"mapId"in E&&t(20,i=E.mapId),"imageUrl"in E&&t(21,s=E.imageUrl),"imageWidth"in E&&t(22,r=E.imageWidth),"imageHeight"in E&&t(23,a=E.imageHeight)},n.$$.update=()=>{n.$$.dirty[0]&26&&t(11,o=m&&w!==null&&y!==null),n.$$.dirty[0]&18874373&&d&&s&&l==="image"&&!A&&He().then(()=>D())},[l,m,d,w,y,u,k,S,R,W,P,o,M,q,L,X,F,ie,se,fe,i,s,r,a,A,N,de,he,V,$,Fe,ze,De,Oe,We]}class Mn extends Ae{constructor(e){super(),Re(this,e,Sn,Pn,Ye,{mapId:20,imageUrl:21,imageWidth:22,imageHeight:23},null,[-1,-1])}}function rt(n){let e,t;return e=new Mn({props:{mapId:n[0],imageUrl:n[3],imageWidth:n[5],imageHeight:n[6]}}),e.$on("close",n[25]),e.$on("added",n[19]),{c(){Je(e.$$.fragment)},m(o,i){Le(e,o,i),t=!0},p(o,i){const s={};i[0]&1&&(s.mapId=o[0]),i[0]&8&&(s.imageUrl=o[3]),i[0]&32&&(s.imageWidth=o[5]),i[0]&64&&(s.imageHeight=o[6]),e.$set(s)},i(o){t||(ne(e.$$.fragment,o),t=!0)},o(o){ge(e.$$.fragment,o),t=!1},d(o){Te(e,o)}}}function at(n){let e,t,o,i;function s(c,l){if(c[1].length===2)return En;if(c[1].length>=3)return Cn}let r=s(n),a=r&&r(n);return{c(){e=h("div"),t=h("div"),t.textContent="üí° Click on a point to edit its coordinates",o=C(),i=h("div"),a&&a.c(),p(t,"class","points-hint svelte-1rzfob"),p(i,"class","transform-status svelte-1rzfob"),p(e,"class","points-info svelte-1rzfob")},m(c,l){j(c,e,l),f(e,t),f(e,o),f(e,i),a&&a.m(i,null)},p(c,l){r===(r=s(c))&&a?a.p(c,l):(a&&a.d(1),a=r&&r(c),a&&(a.c(),a.m(i,null)))},d(c){c&&O(e),a&&a.d()}}}function Cn(n){let e,t=n[1].length+"",o,i;return{c(){e=T("‚úì Affine transform ("),o=T(t),i=T(" points)")},m(s,r){j(s,e,r),j(s,o,r),j(s,i,r)},p(s,r){r[0]&2&&t!==(t=s[1].length+"")&&Z(o,t)},d(s){s&&(O(e),O(o),O(i))}}}function En(n){let e;return{c(){e=T("‚úì Similarity transform")},m(t,o){j(t,e,o)},p:J,d(t){t&&O(e)}}}function ct(n){let e,t,o,i,s=n[9].index+1+"",r,a,c,l,m,u,d,g,_=n[9].imageX.toFixed(0)+"",v,k,S=n[9].imageY.toFixed(0)+"",R,W,P,z,H,w,y,A,D,M,q,L,X,F,ie,re,se,fe,N,de,he;return{c(){e=h("div"),t=h("div"),o=h("h2"),i=T("Edit Point #"),r=T(s),a=C(),c=h("div"),l=h("div"),m=h("strong"),m.textContent="Image coordinates:",u=C(),d=h("span"),g=T("("),v=T(_),k=T(", "),R=T(S),W=T(")"),P=C(),z=h("div"),H=h("label"),H.textContent="Latitude",w=C(),y=h("input"),A=C(),D=h("div"),M=h("label"),M.textContent="Longitude",q=C(),L=h("input"),X=C(),F=h("div"),ie=h("button"),ie.textContent="üóëÔ∏è Delete",re=C(),se=h("button"),se.textContent="Cancel",fe=C(),N=h("button"),N.textContent="Save",p(o,"class","svelte-1rzfob"),p(l,"class","info-row svelte-1rzfob"),p(c,"class","point-edit-info svelte-1rzfob"),p(H,"for","edit-lat"),p(H,"class","svelte-1rzfob"),p(y,"id","edit-lat"),p(y,"type","number"),p(y,"step","any"),p(y,"class","svelte-1rzfob"),p(z,"class","input-group svelte-1rzfob"),p(M,"for","edit-lon"),p(M,"class","svelte-1rzfob"),p(L,"id","edit-lon"),p(L,"type","number"),p(L,"step","any"),p(L,"class","svelte-1rzfob"),p(D,"class","input-group svelte-1rzfob"),p(ie,"class","btn btn-danger svelte-1rzfob"),p(se,"class","btn btn-secondary svelte-1rzfob"),p(N,"class","btn btn-primary svelte-1rzfob"),p(F,"class","button-group svelte-1rzfob"),p(t,"class","modal-content svelte-1rzfob"),p(e,"class","modal-overlay svelte-1rzfob")},m(V,$){j(V,e,$),f(e,t),f(t,o),f(o,i),f(o,r),f(t,a),f(t,c),f(c,l),f(l,m),f(l,u),f(l,d),f(d,g),f(d,v),f(d,k),f(d,R),f(d,W),f(t,P),f(t,z),f(z,H),f(z,w),f(z,y),ce(y,n[9].lat),f(t,A),f(t,D),f(D,M),f(D,q),f(D,L),ce(L,n[9].lon),f(t,X),f(t,F),f(F,ie),f(F,re),f(F,se),f(F,fe),f(F,N),de||(he=[Y(y,"input",n[26]),Y(L,"input",n[27]),Y(ie,"click",n[21]),Y(se,"click",n[22]),Y(N,"click",n[20]),Y(t,"click",zt(n[23])),Y(e,"click",n[22])],de=!0)},p(V,$){$[0]&512&&s!==(s=V[9].index+1+"")&&Z(r,s),$[0]&512&&_!==(_=V[9].imageX.toFixed(0)+"")&&Z(v,_),$[0]&512&&S!==(S=V[9].imageY.toFixed(0)+"")&&Z(R,S),$[0]&512&&ue(y.value)!==V[9].lat&&ce(y,V[9].lat),$[0]&512&&ue(L.value)!==V[9].lon&&ce(L,V[9].lon)},d(V){V&&O(e),de=!1,Q(he)}}}function In(n){let e,t,o,i,s,r,a,c=n[10]?"‚ö†Ô∏è":"üìç",l,m,u,d,g,_=n[8]?"üëÅÔ∏è":"üìù",v,k,S=n[1].length+"",R,W,P,z,H,w,y,A,D,M=n[2]&&n[7]&&rt(n),q=n[8]&&n[1].length>0&&at(n),L=n[9]&&ct(n);return{c(){e=h("div"),t=h("canvas"),o=C(),i=h("div"),s=h("button"),s.textContent="‚Üê Back",r=C(),a=h("button"),l=T(c),m=T(" Add Point"),d=C(),g=h("button"),v=T(_),k=T(" Points ("),R=T(S),W=T(")"),z=C(),M&&M.c(),H=C(),q&&q.c(),w=C(),L&&L.c(),p(t,"class","svelte-1rzfob"),p(s,"class","control-btn back-btn svelte-1rzfob"),p(a,"class",u="control-btn add-point-btn "+(n[10]?"highlight":"")+" svelte-1rzfob"),p(g,"class",P="control-btn edit-points-btn "+(n[8]?"active":"")+" svelte-1rzfob"),p(i,"class","controls svelte-1rzfob"),p(e,"class","viewer-container svelte-1rzfob")},m(X,F){j(X,e,F),f(e,t),n[24](t),f(e,o),f(e,i),f(i,s),f(i,r),f(i,a),f(a,l),f(a,m),f(i,d),f(i,g),f(g,v),f(g,k),f(g,R),f(g,W),f(e,z),M&&M.m(e,null),f(e,H),q&&q.m(e,null),f(e,w),L&&L.m(e,null),y=!0,A||(D=[Y(t,"touchstart",n[11]),Y(t,"touchmove",n[12]),Y(t,"touchend",n[13]),Y(t,"wheel",n[16]),Y(t,"click",n[14]),Y(t,"mousemove",n[15]),Y(s,"click",Ke),Y(a,"click",n[17]),Y(g,"click",n[18])],A=!0)},p(X,F){(!y||F[0]&1024)&&c!==(c=X[10]?"‚ö†Ô∏è":"üìç")&&Z(l,c),(!y||F[0]&1024&&u!==(u="control-btn add-point-btn "+(X[10]?"highlight":"")+" svelte-1rzfob"))&&p(a,"class",u),(!y||F[0]&256)&&_!==(_=X[8]?"üëÅÔ∏è":"üìù")&&Z(v,_),(!y||F[0]&2)&&S!==(S=X[1].length+"")&&Z(R,S),(!y||F[0]&256&&P!==(P="control-btn edit-points-btn "+(X[8]?"active":"")+" svelte-1rzfob"))&&p(g,"class",P),X[2]&&X[7]?M?(M.p(X,F),F[0]&132&&ne(M,1)):(M=rt(X),M.c(),ne(M,1),M.m(e,H)):M&&(gt(),ge(M,1,1,()=>{M=null}),ht()),X[8]&&X[1].length>0?q?q.p(X,F):(q=at(X),q.c(),q.m(e,w)):q&&(q.d(1),q=null),X[9]?L?L.p(X,F):(L=ct(X),L.c(),L.m(e,null)):L&&(L.d(1),L=null)},i(X){y||(ne(M),y=!0)},o(X){ge(M),y=!1},d(X){X&&O(e),n[24](null),M&&M.d(),q&&q.d(),L&&L.d(),A=!1,Q(D)}}}function Ke(){window.location.hash=""}function Yn(n,e,t){let o,{mapId:i}=e,s=null,r=null,a=[],c,l,m,u={scale:1,translateX:0,translateY:0,rotation:0},d=0,g=0,_=0,v=0,k=!1,S=0,R=0,W={x:0,y:0},P=null,z=null,H=null,w=null,y=null,A=!1,D=!1,M=null,q=-1,L=null,X=!1;Xe(async()=>{await F(),ie(),V(),window.addEventListener("resize",re)}),qt(()=>{H!==null&&navigator.geolocation.clearWatch(H),r&&URL.revokeObjectURL(r),L&&cancelAnimationFrame(L),window.removeEventListener("resize",re)});async function F(){try{if(t(2,s=await vt(parseInt(i))),!s){alert("Map not found"),Ke();return}t(3,r=URL.createObjectURL(s.imageBlob)),t(1,a=await wt(parseInt(i))),he()}catch(b){console.error("Error loading map:",b),alert("Failed to load map"),Ke()}}function ie(){c&&(l=c.getContext("2d"),re(),m=new Image,m.onload=()=>{t(5,d=m.width),t(6,g=m.height),se(),N()},m.src=r)}function re(){c&&(_=window.innerWidth,v=window.innerHeight,t(4,c.width=_,c),t(4,c.height=v,c),d>0&&N())}function se(){const b=_/d,I=v/g;u.scale=Math.min(b,I)*.9,u.translateX=_/2,u.translateY=v/2}function fe(b,I){if(!D)return-1;const B=20;for(let G=0;G<a.length;G++){const K=a[G],ae=Math.cos(u.rotation),me=Math.sin(u.rotation),qe=K.imageX-d/2,Be=K.imageY-g/2,Me=qe*u.scale,Qe=Be*u.scale,It=ae*Me-me*Qe,Yt=me*Me+ae*Qe,Xt=It+u.translateX,Lt=Yt+u.translateY;if(Math.hypot(b-Xt,I-Lt)<=B)return G}return-1}function N(){X||(X=!0,L&&cancelAnimationFrame(L),L=requestAnimationFrame(de))}function de(){if(X=!1,!(!l||!m)&&(l.clearRect(0,0,_,v),l.save(),l.translate(u.translateX,u.translateY),l.rotate(u.rotation),l.scale(u.scale,u.scale),l.translate(-d/2,-g/2),l.drawImage(m,0,0,d,g),l.restore(),l.save(),l.translate(u.translateX,u.translateY),l.rotate(u.rotation),l.scale(u.scale,u.scale),l.translate(-d/2,-g/2),a.forEach((b,I)=>{const B=q===I,G=M&&M.id===b.id;if(D||G){l.fillStyle=G?"rgba(255, 152, 0, 0.9)":B?"rgba(33, 150, 243, 0.9)":"rgba(33, 150, 243, 0.7)",l.beginPath(),l.arc(b.imageX,b.imageY,B||G?12:8,0,Math.PI*2),l.fill(),l.strokeStyle="white",l.lineWidth=G?3:2,l.stroke(),l.save(),l.translate(b.imageX,b.imageY),l.scale(1/u.scale,1/u.scale),l.rotate(-u.rotation),l.font="bold 14px sans-serif",l.textAlign="center",l.textBaseline="middle";const K=-25,ae=(I+1).toString(),me=l.measureText(ae).width;l.fillStyle=G?"#FF9800":"#2196F3",l.fillRect(-(me/2+6),K-10,me+12,20),l.fillStyle="white",l.fillText(ae,0,K),l.restore()}else l.fillStyle="rgba(33, 150, 243, 0.7)",l.beginPath(),l.arc(b.imageX,b.imageY,6,0,Math.PI*2),l.fill(),l.strokeStyle="white",l.lineWidth=2,l.stroke()}),l.restore(),z&&w))try{const b=dn(z.longitude,z.latitude,w,y);if(l.save(),l.translate(u.translateX,u.translateY),l.rotate(u.rotation),l.scale(u.scale,u.scale),z.accuracy){const B=z.accuracy/111e3*Math.abs(w.a||w.scale);l.strokeStyle="rgba(76, 175, 80, 0.3)",l.fillStyle="rgba(76, 175, 80, 0.1)",l.lineWidth=2,l.beginPath(),l.arc(b.imageX,b.imageY,B,0,Math.PI*2),l.fill(),l.stroke()}l.fillStyle="#4CAF50",l.beginPath(),l.arc(b.imageX,b.imageY,10,0,Math.PI*2),l.fill(),l.strokeStyle="white",l.lineWidth=3,l.stroke(),l.fillStyle="white",l.beginPath(),l.arc(b.imageX,b.imageY,3,0,Math.PI*2),l.fill(),l.restore()}catch(b){console.error("Error drawing user position:",b)}}function he(){const b=mn(a);b?(w=b.transform,y=b.type):(w=null,y=null)}function V(){if(!navigator.geolocation){console.warn("Geolocation not supported");return}H=navigator.geolocation.watchPosition(b=>{z={latitude:b.coords.latitude,longitude:b.coords.longitude,accuracy:b.coords.accuracy},N()},b=>{console.error("GPS error:",b)},{enableHighAccuracy:!0,maximumAge:5e3,timeout:1e4})}function $(b){if(b.preventDefault(),b.touches.length===1){k=!0;const I=b.touches[0];W={x:I.clientX,y:I.clientY},P={...u}}else if(b.touches.length===2){k=!1;const I=b.touches[0],B=b.touches[1];S=Math.hypot(B.clientX-I.clientX,B.clientY-I.clientY),R=Math.atan2(B.clientY-I.clientY,B.clientX-I.clientX),W={x:(I.clientX+B.clientX)/2,y:(I.clientY+B.clientY)/2},P={...u}}}function Fe(b){if(b.preventDefault(),b.touches.length===1&&k){const I=b.touches[0],B=I.clientX-W.x,G=I.clientY-W.y;u.translateX=P.translateX+B,u.translateY=P.translateY+G,N()}else if(b.touches.length===2){const I=b.touches[0],B=b.touches[1],G=Math.hypot(B.clientX-I.clientX,B.clientY-I.clientY),K=Math.atan2(B.clientY-I.clientY,B.clientX-I.clientX),ae={x:(I.clientX+B.clientX)/2,y:(I.clientY+B.clientY)/2},me=G/S;u.scale=P.scale*me,u.scale=Math.max(.1,Math.min(10,u.scale));const qe=K-R;u.rotation=P.rotation+qe;const Be=ae.x-W.x,Me=ae.y-W.y;u.translateX=P.translateX+Be,u.translateY=P.translateY+Me,N()}}function ze(b){k=!1}function De(b){if(!D)return;const I=c.getBoundingClientRect(),B=b.clientX-I.left,G=b.clientY-I.top,K=fe(B,G);K>=0&&(t(9,M={...a[K],index:K}),N())}function Oe(b){if(!D){q!==-1&&(q=-1,N());return}const I=c.getBoundingClientRect(),B=b.clientX-I.left,G=b.clientY-I.top,K=fe(B,G);K!==q&&(q=K,t(4,c.style.cursor=K>=0?"pointer":"default",c),N())}function We(b){b.preventDefault();const I=b.deltaY>0?.9:1.1;u.scale*=I,u.scale=Math.max(.1,Math.min(10,u.scale)),N()}function E(){t(7,A=!0)}function U(){t(8,D=!D),D||(t(9,M=null),q=-1),N()}function ee(){t(7,A=!1),F()}async function te(){if(M)try{const{updateReferencePoint:b}=await Ve(async()=>{const{updateReferencePoint:I}=await Promise.resolve().then(()=>nt);return{updateReferencePoint:I}},void 0);await b(M.id,{lon:M.lon,lat:M.lat}),t(9,M=null),await F(),N()}catch(b){console.error("Error updating point:",b),alert("Failed to update point")}}async function Pe(){if(!(!M||!confirm("Delete this reference point?")))try{const{deleteReferencePoint:b}=await Ve(async()=>{const{deleteReferencePoint:I}=await Promise.resolve().then(()=>nt);return{deleteReferencePoint:I}},void 0);await b(M.id),t(9,M=null),await F(),N()}catch(b){console.error("Error deleting point:",b),alert("Failed to delete point")}}function Se(){t(9,M=null),N()}function Pt(b){jt.call(this,n,b)}function St(b){we[b?"unshift":"push"](()=>{c=b,t(4,c)})}const Mt=()=>t(7,A=!1);function Ct(){M.lat=ue(this.value),t(9,M)}function Et(){M.lon=ue(this.value),t(9,M)}return n.$$set=b=>{"mapId"in b&&t(0,i=b.mapId)},n.$$.update=()=>{n.$$.dirty[0]&2&&t(10,o=a.length<3)},[i,a,s,r,c,d,g,A,D,M,o,$,Fe,ze,De,Oe,We,E,U,ee,te,Pe,Se,Pt,St,Mt,Ct,Et]}class Xn extends Ae{constructor(e){super(),Re(this,e,Yn,In,Ye,{mapId:0},null,[-1,-1])}}function Ln(n){let e,t;return e=new Xn({props:{mapId:n[1]}}),{c(){Je(e.$$.fragment)},m(o,i){Le(e,o,i),t=!0},p(o,i){const s={};i&2&&(s.mapId=o[1]),e.$set(s)},i(o){t||(ne(e.$$.fragment,o),t=!0)},o(o){ge(e.$$.fragment,o),t=!1},d(o){Te(e,o)}}}function Tn(n){let e,t;return e=new rn({}),{c(){Je(e.$$.fragment)},m(o,i){Le(e,o,i),t=!0},p:J,i(o){t||(ne(e.$$.fragment,o),t=!0)},o(o){ge(e.$$.fragment,o),t=!1},d(o){Te(e,o)}}}function Rn(n){let e,t,o,i;const s=[Tn,Ln],r=[];function a(c,l){return c[0]==="list"?0:c[0]==="viewer"&&c[1]?1:-1}return~(e=a(n))&&(t=r[e]=s[e](n)),{c(){t&&t.c(),o=Ft()},m(c,l){~e&&r[e].m(c,l),j(c,o,l),i=!0},p(c,[l]){let m=e;e=a(c),e===m?~e&&r[e].p(c,l):(t&&(gt(),ge(r[m],1,1,()=>{r[m]=null}),ht()),~e?(t=r[e],t?t.p(c,l):(t=r[e]=s[e](c),t.c()),ne(t,1),t.m(o.parentNode,o)):t=null)},i(c){i||(ne(t),i=!0)},o(c){ge(t),i=!1},d(c){c&&O(o),~e&&r[e].d(c)}}}function An(n,e,t){let o="list",i=null;Xe(async()=>(await le(),s(),window.addEventListener("hashchange",s),()=>{window.removeEventListener("hashchange",s)}));function s(){const r=window.location.hash;if(r.startsWith("#map/")){const a=r.substring(5);t(1,i=a),t(0,o="viewer")}else t(0,o="list"),t(1,i=null)}return[o,i]}class Fn extends Ae{constructor(e){super(),Re(this,e,An,Rn,Ye,{})}}new Fn({target:document.getElementById("app")});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/byom/sw.js").then(n=>{console.log("ServiceWorker registered:",n)}).catch(n=>{console.log("ServiceWorker registration failed:",n)})});
